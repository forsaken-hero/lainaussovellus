{% extends "layout.html" %}
{% block title %}Haku{% endblock %}
{% block header %}Haku{% endblock %}

{% block content %}

<form action="{{ url_for('search') }}" method="GET">
  <p>
    <label for="search_bar_page">Hae:</label>
    <input type="text" id="search_bar_page" name="query" value = "{{query if query else '' }}" minlength = "1" placeholder="Hae..." required> <input type="submit" value="Hae">
  </p>
</form>

{% if query %}
  {% if (results | length) > 0 %}
    <p class="main_text">Tulokset hakusanalla '{{query}}':</p>
    <div class ="item_display_wrapper">
      <div class = "item_display_container">
        {% for key, value in results[:10] %}
          <div class = "item_display_grid">
            <a href="/item/{{key['item_id']}}" class="item_button">{{key['item_name']}}</a> 
            {% if key['item_picture'] %}<img src="data:image/png;base64,{{ key['item_picture'] }}" alt="Tavaran {{ key['item_name'] }} kuva" class="item_picture">{% endif %}
              <div class = "pusher">
                {% if value | length > 0 %}
                
                  <p class = "item_display_grid_text">Haun osumat</p>
                  <div class = "search_result_container">
                    <div class = "search_result_grid">

                      {% for each in value %}
                        <div class = "right_justify">{{each}}</div><div>:</div>
                        <div>
                          {% for text in value[each] %}
                            <ul class = "search left_justify wrap">{% if each == "Omistaja" %}<a href="/user/{{text}}" id = "user_link">{{text}}</a>{% else %}{{text}}{% endif %}</ul>
                          {% endfor %}
                        </div>
                      {% endfor %}

                    </div>
                  </div>
                {% endif %}
                <div class = "button_wrapper">
                  {% if key['owner_id'] == session["user_id"] %}
                    <a href="/edit/{{ key['item_id'] }}" class="edit button">Muokkaa</a>  
                    {% if key['borrower_id'] %}{% else %}<a href="/remove/{{ key['item_id'] }}" class="remove button">Poista</a>{% endif %}
                  {% endif %}
                  {% if key['borrower_id'] %}
                    {% if key['borrower_id'] == session["user_id"] %}<a href="/return/{{ key['item_id'] }}" class = "return button">Palauta</a>{% endif %}
                  {% else %}
                    <a href="/borrow/{{ key['item_id'] }}" class="borrow button">Lainaa</a>
                  {% endif %}
                </div>

              </div>
            
          </div>
        {% endfor %}
      </div>

      {% if (page == 1) and ((results | length) <= page_size) %}
      {% else %}
        <p class="page_nav">
          {% if page >= 2 %}<a href="{{ url_for('search', query = query, page = page - 1) }}" class = "page_button">&lt;&lt;</a>{% endif %}
          Sivu {{ page }}
          {% if (results | length) > page_size %}<a href="{{ url_for('search', query = query, page = page + 1) }}" class = "page_button">&gt;&gt;</a>{% endif %}
        </p>
      {% endif %}
    </div>
  {% else %}
    <p for="main_text"> Ei ole tuloksia hakusanalla '{{query}}'.</p>
  {% endif %}
{% endif %}

{% endblock %}